{% extends "base.html" %}
{% load static %}

{% block title %}Complaint Management{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'style/complain_status.css' %}">
  <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"> -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <link rel="icon" href="/favicon.png" type="image/png">
{% endblock %}



{% block content %}
  <div class="container-main">
    {% if latest_status.status == 'CLOSED' %}
    <div class="alert alert-warning d-flex align-items-center mb-4" style="border-radius:8px; font-size:1.1rem;">
      <i class="fas fa-lock fa-lg me-3 text-danger"></i>
      <div>
        <strong>Complaint Closed:</strong> No further actions can be performed on this complaint.
      </div>
    </div>
    {% endif %}
    <!-- Role Selector -->
    

    <!-- Complaint Header -->
    <div class="complaint-header">
      <div class="row">
        <div class="complaint-id">#{{event.unique_token}}</div>
        <div class="customer-name">{{event.serial_number}}</div>

        <div class="row">
          <div class="col-md-8 order-2 order-md-1">
            <div class="mt-2 header">
              <span class="status-badge status-active">  {{ latest_status.get_status_display|default:"No Status" }}</span>
              <span 
                  class="location-badge location-oem" 
                  id="repairLocationBadge"
                  data-location="{{ location_data.location|default:'' }}">
                  <i class="fas fa-map-marker-alt"></i>
                  <span id="repairLocationText">
                    {{ location_data.location|default:"Not Defined" }}
                  </span>
                </span>

              {% if timing_status == "Not Started" %}
              <span class="badge bg-secondary location-badge p-2">
                <i class="fa-solid fa-clock"></i> Not Started
              </span>

            {% elif timing_status == "On Time" %}
              {% if total_days is not None %}
                <span class="badge bg-success location-badge p-2">
            <i class="fa-solid fa-clock"></i> On Time ({{ total_days }} days) <i class="fas fa-check-circle"></i>
                </span>
              {% else %}
                <span class="badge bg-success location-badge p-2">
                  <i class="fas fa-check-circle"></i> On Time
                </span>
              {% endif %}

            {% elif timing_status == "Late" %}
              {% if total_days is not None %}
                <span class="badge bg-danger location-badge p-2">
                  <i class="fa-solid fa-clock"></i> Late ({{ total_days }} days) <i class="fas fa-exclamation-triangle"></i>
                </span>
              {% else %}
                <span class="badge bg-danger location-badge p-2">
                  <i class="fas fa-exclamation-triangle"></i> Late
                </span>
              {% endif %}
            {% endif %}


              
              <!-- <span class="customer-only ms-2">Awaiting Your Approval</span> -->
              <!-- <span class="oem-only ms-2">Assigned to: John Smith</span> -->
            </div>
          </div>
        
        <!-- Right side with Image and Export Button -->
          <div class="col-md-4 order-1 order-md-2 text-md-end p-0">
            <div class="d-flex align-items-center justify-content-end gap-3">
              <!-- Product Image Section -->
              <div class="product-image-wrapper">
                {% if event.uav_type  == "JF2" %}
                    <img src="{% static 'images/jf2.png' %}" alt="{{ event.tail_number }}" class="product-image">
                {% elif "JM" in event.uav_type  %}
                    <img src="{% static 'images/jm1.png' %}" alt="{{ event.tail_number }}" class="product-image">

                {% endif %}
              </div>
              <div class="col-md-6 text-md-end">
                <div class="col-auto">
                    <a href="{% url 'complaint_list' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i> Back to Complaints
                    </a>

                </div>
                <div class="text-muted small">Product: {{event.serial_number}}</div>
                <div class="text-muted small">Tail No: {{event.tail_number}}</div>
                <div class="text-muted small">Registered at: {{ event.reported_at|date:"d/m/Y" }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

    <div class="row">
      <!-- Left Column - Complaint Tracking -->
      <div class="col-lg-8">
        <div class="row">
          <div class="col-12 col-lg-12">
            <!-- Complaint Tracking -->
            <div class="card">
              <div class="card-header">
                <i class="fas fa-list-alt me-2"></i>Complaint Tracking
              </div>
              <div class="card-body">
                <div class="timeline-container">
                  <div class="timeline" id="complaintTimeline">
                    {% for s in statuses %}
                    <!-- <div class="timeline-item"> -->
                    <div class="timeline-item {% if s.status == 'CLOSED' %}closed{% endif %}">
                      <div class="timeline-marker 
                          {% if forloop.last %}active
                          {% elif not forloop.last %}completed
                          {% endif %}">
                          
                          {% if s.status == "IN REVIEW" %}
                            <i class="fas fa-check"></i>
                          {% elif s.status == "ACCEPTED" %}
                            <i class="fas fa-user-check"></i>
                          {% elif s.status == "DIAGNOSIS REPORT" %}
                            <i class="fas fa-cog"></i>
                          {% elif s.status == "REPAIR" %}
                            <i class="fas fa-tools"></i>
                          {% elif s.status == "READY FOR DISPATCH" %}
                            <i class="fas fa-shipping-fast"></i>
                          {% elif s.status == "REJECTED" %}
                            <i class="fas fa-times-circle"></i>
                          {% elif s.status == "CLOSED" %}
                            <i class="fas fa-box-open"></i>
                          {% else %}
                            <i class="fas fa-info-circle"></i>
                          {% endif %}
                      </div>

                      <div class="timeline-content">
                        <div class="timeline-date">{{ s.updated_at|date:"d/m/Y" }}</div>
                        <div class="timeline-title">{{ s.status }}</div>
                        <p class="timeline-description">
                          {{ s.remarks|default:"" }}
                        </p>

                        {%if s.status == "ACCEPTED" %}
                          <p class="timeline-info">You will get the diagnosis report within 3 days once we receive the product at our warehouse.</p>
                        {% endif %}
                        {% if s.status == 'DIAGNOSIS REPORT' and event.customer_pricing.approved_pay != True %}
                          <p class="timeline-info">When the payment is approved by you, it takes 7 days to repair the product.</p>
                        {% endif %}

                        {% if s.attachments %}
                          <a href="{{ s.attachments.url }}" target="_blank">
                            <i class="fas fa-paperclip"></i> View Attachment
                          </a>
                        {% else %}
                        {% endif %}

                        <!-- ✅ Edit button opens modal with the status ID -->
                        {% if user.role == "CSM" and latest_status.status != 'CLOSED' %}
                         <div class="d-flex mt-2" title="Edit Status">
                            <a href="#" 
                              class="btn btn-sm btn-outline-primary"
                              data-bs-toggle="modal"
                              data-bs-target="#editStatusModal"
                              data-status-id="{{ s.id }}"
                              data-status="{{ s.status }}"
                              data-remarks="{{ s.remarks|default:''}}">
                              <i class="fas fa-edit" ></i>
                            </a>
                            <!-- Delete Button -->
                            <form method="POST" action="{% url 'delete_status' s.id %}" onsubmit="event.preventDefault(); confirmDelete(this);">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger ms-1" title="Delete Status">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                            <script>
                              function confirmDelete(form) {
                                openPopup('Are you sure you want to delete this status?', function() {
                                  form.submit(); // Submit the form only if OK is clicked
                                });
                              }
                            </script>

                        </div>
                        {% endif %}
                    </div>
                    </div>
                    {% empty %}
                      <p>No status updates yet.</p>
                    {% endfor %}

                  </div>

                </div>
              </div>
            </div>
          </div>
          
        </div>

        <!-- Cost Summary -->

        <div class="card oem-only">
          {% if user.role != "CUSTOMER" %}
          <div>
            <div class="card-header">
              <i class="fas fa-chart-bar me-2"></i>Cost Summary
            </div>
            <div class="card-body">
              <div class="cost-breakdown-section">
                <div class="cost-item">
                  <span class="cost-label">Total Repair Cost:</span>
                  <span class="cost-value oem-cost" id="totalRepairCost">₹{{ total_repair_cost|floatformat:2 }}</span>
                </div>
                <div class="cost-item">
                  <span class="cost-label">Price to Customer:</span>
                  <span class="cost-value customer-cost" id="priceToCustomer">₹{{ total_customer_cost|floatformat:2 }}</span>
                </div>
                <div class="profit-loss" id="profitLossIndicator">
                  <!-- Profit/Loss indicator will be shown here -->
                {% if profit_value is not None %}
                  {% if profit_value > 0 %}
                    <div class="alert alert-success mb-0 py-2">
                      <strong>Profit:</strong> ₹{{ profit_value|floatformat:2 }}
                      {% if profit_percent %}<small class="ms-2 text-muted">({{ profit_percent|floatformat:2 }}%)</small>{% endif %}
                    </div>
                  {% elif profit_value < 0 %}
                    <div class="alert alert-danger mb-0 py-2">
                      <strong>Loss:</strong> ₹{{ profit_value|floatformat:2 }}
                    </div>
                  {% else %}
                    <div class="alert alert-secondary mb-0 py-2">Profit/Loss</div>
                  {% endif %}
                {% else %}
                  <div class="text-muted small">No pricing data</div>
                {% endif %}
                </div>
              </div>
            </div>
              
              <!-- Repair Cost History -->
              <div class="m-3">
                <h6 class="mb-2">Repair Cost History</h6>
                <div class="repair-cost-history" id="repairCostHistory">
                  {% if repair_cost %}
                    {% for cost in repair_cost %}
                      <div class="d-flex justify-content-between align-items-start mb-2 p-2 border rounded bg-light">
                        <div>
                          <div class="fw-bold small">{{ cost.description|default:"No description" }}</div>
                          <div class="text-muted smaller">
                            {{ cost.created_at|date:"d/m/Y H:i" }}
                          </div>
                          {% if cost.attachment %}
                            <a href="{{ cost.attachment.url }}" class="attachment-link smaller" target="_blank">
                              <i class="fas fa-paperclip me-1"></i> View Attachment
                            </a>
                          {% endif %}
                        </div>
                        <div class="text-warning fw-bold d-flex flex-column">₹{{ cost.repair_cost|floatformat:2 }}
                        {% if user.role == "CSM" %}
                          <form method="POST" id="deleteRepairCost" action="{% url 'delete_repair_cost' cost.id %}" class="mt-1">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-danger ms-3" onclick="deleteRepairCost(event)">
                              <i class="fas fa-trash"></i> 
                            </button>
                          </form>
                        {% endif %}
                        </div>
                      </div>
                    {% endfor %}
                  {% else %}
                    <p class="text-muted small">No repair costs added yet.</p>
                  {% endif %}
                </div>
              </div>

          </div>
          {% endif %}
        </div>
        <!-- Customer Only: Cost Estimate Approval -->
        {% if user.role == "CUSTOMER" %}
        <div class="card customer-only">
          <div class="card-header">
            <i class="fas fa-file-invoice-dollar me-2"></i>Repair Cost Estimate
          </div>
          <div class="card-body">
            <div class="cost-breakdown-section">
              <div class="cost-item">
                <span class="cost-label">Total Repair Cost:</span>
                <span class="cost-value customer-cost" id="customerTotalCost">₹{{ total_customer_cost|floatformat:2 }}</span>
              </div>
              <div class="mt-2">
                {% if event.customer_pricing.invoice %}
                <a href="{{ event.customer_pricing.invoice.url }}" class="attachment-link" id="customerInvoiceLink" target="_blank">
                  <i class="fas fa-file-invoice me-1"></i>View Invoice
                </a>
                {% else %}
                <i class="fas fa-file-invoice me-1"></i>No Invoice
                {% endif %}
              </div>
            </div>
            
            {% comment %} {% if perms.oem.change_customerpricing %} {% endcomment %}
            {% with pricing=event.customer_pricing %}
            {% if pricing %}
            <div class="action-buttons flex-column mt-4">

    <!-- Payment Conditions -->
    <div class="alert alert-light border mb-4">

      <h5 class="fw-bold mb-3">
        Payment Options & Conditions / भुगतान विकल्प एवं शर्तें
      </h5>

      <ol class="mb-0">

        <li class="mb-3">
          <strong>Approve & Pay Now</strong><br>
          <span class="text-dark">
            You approve the estimated service and/or spare costs. Payment must be
            completed through the system payment link. Repairs will begin only
            after confirmation of payment receipt.
          </span>
          <br>
          <span class="text-muted">
            आप सेवा एवं/या स्पेयर पार्ट्स की अनुमानित लागत को स्वीकृत करते हैं।
            भुगतान सिस्टम द्वारा उपलब्ध कराए गए भुगतान लिंक के माध्यम से किया जाना
            अनिवार्य है। भुगतान प्राप्त होने की पुष्टि के बाद ही मरम्मत कार्य प्रारंभ
            किया जाएगा।
          </span>
        </li>

        <li class="mb-3">
          <strong>Pay on Collection</strong><br>
          <span class="text-dark">
            You approve the estimated costs. Payment is required at the time of
            collection after completion of repairs. Release of equipment is subject
            to confirmation of payment.
          </span>
          <br>
          <span class="text-muted">
            आप अनुमानित लागत को स्वीकृत करते हैं। मरम्मत पूर्ण होने के पश्चात उपकरण
            प्राप्त करते समय भुगतान किया जाना आवश्यक है। भुगतान की पुष्टि के बाद ही
            उपकरण जारी किया जाएगा।
          </span>
        </li>

        <li>
          <strong>Payment through GeM (Government e-Marketplace)</strong><br>
          <span class="text-dark">
            You opt to process payment through the GeM portal. Repairs will
            commence only after completion of the GeM process and formal award of
            contract, in accordance with applicable government procurement rules.
          </span>
          <br>
          <span class="text-muted">
            आप भुगतान प्रक्रिया GeM (Government e-Marketplace) पोर्टल के माध्यम से
            करने का विकल्प चुनते हैं। सरकारी क्रय नियमों के अनुसार GeM प्रक्रिया पूर्ण
            होने तथा औपचारिक अनुबंध स्वीकृत होने के बाद ही मरम्मत कार्य प्रारंभ किया
            जाएगा।
          </span>
        </li>

      </ol>
    </div>

    <!-- Buttons -->
     {% if pricing.approved_pay or pricing.approved_pay_later or pricing.approved_through_gem %}
      <span class="text-danger fw-bold">
        The selected payment option is highlighted.
      </span>
    {% endif %}


    <form action="{% url 'customer_price_approve' pricing.id %}" method="post">
      {% csrf_token %}

      <div class="d-flex flex-column flex-md-row gap-2">

        <!-- PAY NOW -->
        <button type="submit"
          name="action"
          value="pay_now"
          class="btn flex-fill
          {% if pricing.approved_pay %}btn-success active{% else %}btn-outline-success{% endif %}"
          {% if pricing.approved_pay or pricing.approved_pay_later or pricing.approved_through_gem %}
            disabled
          {% endif %}>
          <i class="fas fa-check-circle me-2"></i>
          Approve & Pay Now
        </button>


        <!-- PAY LATER -->
        <button type="submit"
          name="action"
          value="pay_later"
          class="btn flex-fill
          {% if pricing.approved_pay_later %}btn-primary active{% else %}btn-outline-primary{% endif %}"
          {% if pricing.approved_pay or pricing.approved_pay_later or pricing.approved_through_gem %}
            disabled
          {% endif %}>
          <i class="fas fa-hourglass-half me-2"></i>
          Pay on Collection
        </button>


        <!-- GEM -->
        <button type="submit"
          name="action"
          value="gem"
          class="btn flex-fill
          {% if pricing.approved_through_gem %}btn-warning active{% else %}btn-outline-warning{% endif %}"
          {% if pricing.approved_pay or pricing.approved_pay_later or pricing.approved_through_gem %}
            disabled
          {% endif %}>
          <i class="fas fa-landmark me-2"></i>
          Pay via GeM
        </button>


      </div>
    </form>

{% endif %}
{% endwith %}

  </div>


          </div>
        </div>
        {% endif %}
        
      </div>

      <!-- Right Column - OEM Panels -->
      <div class="col-lg-4" id="oemPanels">
        
        <!-- Set Repair Location -->
        <input type="hidden" id="locationData" value="{{ location_data.id }}">
        <div class="card oem-only">
        {% if  perms.oem.add_repairlocation %}
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <i class="fas fa-map-marker-alt me-2"></i>Set Repair Location
            </div>
            {% if latest_status.status != 'CLOSED' %}
              <button type="button" class="btn btn-outline-primary btn-sm" title="Edit Location" id="enableEditBtn">
                <i class="fas fa-edit"></i>
              </button>
            {% endif %}

          </div>
          <div class="card-body">
            <form method="POST" action="{% url 'set_complaint_location' event.id %}" id="locationForm">
              {% csrf_token %}
              
              <div id="locationSelection" class="d-flex flex-column gap-3 mb-3">
                <div class="location-option p-3 border rounded" data-location="OEM Site">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <div class="location-icon mb-1">
                        <i class="fas fa-warehouse fa-lg"></i>
                      </div>
                      <h6 class="mb-1">OEM Site</h6>
                      <p class="small text-muted mb-0">Repair will be conducted at our service center</p>
                    </div>
                     <!-- Bullet indicator -->
                    <span class="location-radio"></span>
                  </div>
                </div>

                <div class="location-option p-3 border rounded" data-location="Virtual Assistance">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <div class="location-icon mb-1">
                        <i class="fas fa-desktop fa-lg"></i>
                      </div>
                      <h6 class="mb-1">Virtual Assistance</h6>
                      <p class="small text-muted mb-0">Remote diagnosis and guidance</p>
                    </div>
                    <!-- Bullet indicator -->
                    <span class="location-radio"></span>
                  </div>
                </div>

                <div class="location-option p-3 border rounded" data-location="Customer Site">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <div class="location-icon mb-1">
                        <i class="fas fa-home fa-lg"></i>
                      </div>
                      <h6 class="mb-1">Customer Site</h6>
                      <p class="small text-muted mb-0">On-site repair at customer location</p>
                    </div>
                    <!-- Bullet indicator -->
                    <span class="location-radio"></span>
                  </div>
                </div>

              </div>

              <!-- Hidden input to store the selected location -->
              <input type="hidden" name="location" id="selectedLocation">

              <!-- <div class="mb-3">
                <label for="locationRemarks" class="form-label">Location Remarks (Optional)</label>
                <textarea class="form-control" name="remarks" id="locationRemarks" rows="2" placeholder="Add any specific instructions or notes about the location..."></textarea>
              </div> -->

              <div class="d-grid">
                <button type="submit" class="btn btn-primary" id="saveLocationBtn">
                  <i class="fas fa-save me-2"></i>Save Location
                </button>
              </div>
            </form>
          </div>
      {%endif%}
    

        </div>

        <!-- Update Complaint Status -->
        {% if perms.oem.add_complaintstatus%}
          <div class="card oem-only">
            <div class="card-header">
              <i class="fas fa-sync me-2"></i>Update Complaint Status
            </div>
            <div class="card-body">
              <form method="post" id="updateStatus" enctype="multipart/form-data" action="{% url 'update_complaint_status' pk=event.id %}">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="update_status">

                <div class="mb-3">
                  {{ form.status.label_tag }}
                  {{ form.status }}
                </div>

                <div class="mb-3">
                  {{ form.remarks.label_tag }}
                  {{ form.remarks }}
                </div>

                <div class="mb-3">
                  {{ form.attachments.label_tag }}
                  {{ form.attachments }}
                </div>

                <div class="d-grid">
                  <button type="submit" class="btn btn-primary" onclick="statusEdit(event)" {% if latest_status.status == 'CLOSED' %} disabled {% endif %}>
                    <i class="fas fa-save me-2"></i>Update Status
                  </button>
                </div>
              </form>


              {% if latest_status %}
                <p class="mt-3">
                  <strong>Last Updated:</strong> {{ latest_status.get_status_display }} on {{ latest_status.updated_at|date:"d M Y, H:i" }}
                </p>
                {% if latest_status.attachments %}
                  <p><strong>Attachment:</strong> 
                    <a href="{{ latest_status.attachments.url }}" target="_blank">{{ latest_status.attachments.name }}</a>
                  </p>
                {% endif %}
              {% endif %}
            </div>
          </div>
        {%endif %}


        <!-- Add Repair Cost -->
         {% comment %} {% if user.role == "EMP-OPS" or user.role == "CSM" or user.role == "DIRECTOR" %} {% endcomment %}
         {% if perms.oem.add_repaircost%}
        <div class="card oem-only">
          <div class="card-header">
            <i class="fas fa-tools me-2"></i>Add Repair Cost
          </div>
          <div class="card-body">
            <form method="post" id="addRepairCostForm" enctype="multipart/form-data" action="{% url 'add_repair_cost' pk=event.id %}">
                {% csrf_token %}

                <div class="mb-3">
                  {{ cost_form.description.label_tag }}
                  {{ cost_form.description }}
                </div>
               
                <div class="mb-3">
                  {{ cost_form.repair_cost.label_tag }}
                  {{ cost_form.repair_cost }}
                </div>

                <div class="mb-3">
                  {{ cost_form.attachment.label_tag }}
                  {{ cost_form.attachment }}
                </div>

                <div class="d-grid">
                  <button type="submit" onclick="addRepairCost(event)" class="btn btn-warning" {% if latest_status.status == 'CLOSED' %} disabled {% endif %}>
                    <i class="fas fa-plus-circle me-2"></i>Add Repair Cost
                  </button>
                </div>
              </form>
          </div>
        </div>

        {% endif %}
        <!-- Set Customer Pricing -->
          {% if perms.oem.add_customerpricing%}
          {% comment %} {% if event.customer_pricing and not event.customer_pricing.approved_pay and not event.customer_pricing.approved_pay_later %} {% endcomment %}
        
          <div class="card oem-only mt-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <i class="fas fa-tag me-2"></i>Set Customer Pricing
            </div>
            {% if event.customer_pricing.total_price and latest_status.status != 'CLOSED' %}
              <button type="button" id="enableEditCost" class="btn btn-outline-primary btn-sm"><i class="fas fa-edit"></i>
              </button>
            {% endif %}
          </div>

          <div class="card-body">
            <form method="post" enctype="multipart/form-data"
                  action="{% url 'add_customer_cost' event.id %}"
                  id="customerPricingForm">
              {% csrf_token %}

              <div class="mb-3">
                <label for="customerPrice" class="form-label">Total Price to Customer (₹)</label>
                <input 
                  type="number"
                  name="total_price"
                  class="form-control"
                  id="customerPrice"
                  value="{{ event.customer_pricing.total_price|default_if_none:'' }}"
                  placeholder="0.00" min="0" step="0.01"
                  {% if event.customer_pricing.total_price %}disabled{% endif %}
                >
              </div>

              <div class="mb-3">
                <label for="customerInvoice" class="form-label">Invoice Attachment</label>
                <input 
                  type="file"
                  name="invoice"
                  class="form-control"
                  id="customerInvoice"
                  {% if event.customer_pricing.total_price %}disabled{% endif %}
                >
                {% if event.customer_pricing.invoice %}
                  <small class="text-muted">
                    Existing: <a href="{{ event.customer_pricing.invoice.url }}" target="_blank">View Invoice</a>
                  </small>
                {% endif %}
              </div>

              <div class="d-grid">
                <button 
                  type="submit"
                  class="btn btn-success"
                  id="submitBtn"
                  onclick="addCustomerCost(event)"
                  {% if event.customer_pricing.total_price %}disabled{% endif %}
                >
                  <i class="fas fa-paper-plane me-2"></i>Send to Customer
                </button>
              </div>
            </form>
          </div>
          </div>



      {% comment %} {% endif %} {% endcomment %}
        <!-- Set Customer Pricing Closed --> 
         
        {% endif %}

      </div>
    </div>
  </div>

  <!-- Edit Status Modal -->
<div class="modal fade" id="editStatusModal" tabindex="-1" aria-labelledby="editStatusLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <!-- Static action URL -->
      <form method="POST" id="updateStatusForm">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="editStatusLabel">Edit Status</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="status_id" id="statusId">

          <div class="mb-3">
            <label class="form-label">Status</label>
            <select name="status" id="statusSelect" class="form-select">
              {% for choice_value, choice_label in status_choices %}
                <option value="{{ choice_value }}">{{ choice_label }}</option>
              {% endfor %}
            </select>

          </div>

          <div class="mb-3">
            <label class="form-label">Remarks</label>
            <textarea name="remarks" id="remarksInput" class="form-control" rows="3"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" id="saveEditBtn" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {

    const badge = document.getElementById("repairLocationBadge");
    const badgeLocation = badge?.dataset.location?.trim();

    const options = document.querySelectorAll(".location-option");
    const selectedInput = document.getElementById("selectedLocation");

    if (!badgeLocation) return;

    options.forEach(option => {
        if (option.dataset.location === badgeLocation) {
            option.classList.add("selected", "border-primary", "bg-light");
            selectedInput.value = badgeLocation;
        }
    });

});
</script>
  
{% block extra_scripts %}
<!-- JS -->
<script src="{% static 'js/location.js' %}"></script>
<script src="{% static 'js/popup_msg.js' %}"></script>
<script src="{% static 'js/status.js' %}"></script>
<script src="{% static 'js/customer_costs.js' %}"></script>



{% endblock %}

{% endblock %}