{% extends "uav-portal/base.html" %}

{% block title %}Dashboard - CSM{% endblock %}

{% block content %}
<div class="container p-0">
    <h3 class="mb-4">Ticekt Tracking</h3>

    <table class="table table-bordered table-hover">
    <thead class="thead-dark">
        <tr class="text-center">
            <th>Event</th>
            <th>Current Status</th>
            <th>Repair Location</th>
            <th>Remarks</th>

            {% if request.user.role == "CSM" %}
                <th>Actions</th>
            {% endif %}

            <th>History</th>
        </tr>
    </thead>
    <tbody>
        {% for approval in approvals %}
        <tr>
            <form method="POST" action="">
                {% csrf_token %}
                <td>{{ approval.event.unique_token }}</td>

                <!-- Status Dropdown -->
                <td>
                    <select name="status" class="form-control" 
                        {% if request.user.role != "CSM" %}disabled{% endif %}>
                        {% for value, label in histories.model.STATUS_CHOICES %}
                            <option value="{{ value }}"
                                {% if approval.history.last and approval.history.last.status == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </td>

                <!-- Location Dropdown -->
                <td>
                    <select name="location" class="form-control"
                        {% if request.user.role != "CSM" %}disabled{% endif %}>
                        {% for value, label in histories.model.LOCATION_CHOICES %}
                            <option value="{{ value }}"
                                {% if approval.history.last and approval.history.last.location == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </td>

                <!-- Remarks -->
                <td>
                    <textarea name="remarks" class="form-control" rows="1"
                        {% if request.user.role != "CSM" %}readonly{% endif %}>
                        {% if approval.history.last %}
                        <!-- {{ approval.history.last.remarks }} -->
                        
                        {% endif %}
                    </textarea>
                </td>

                <!-- Update Button -->
                {% if request.user.role == "CSM" %}
                <td class="text-center">
                    <input type="hidden" name="approval_id" value="{{ approval.id }}">
                    <button type="submit" class="btn btn-sm btn-primary">Update</button>
                </td>
                {% endif %}

                <!-- History Toggle -->
                <td class="text-center">
                    <button type="button" class="btn btn-sm"
                        style="background-color: var(--accent);"   
                        data-bs-toggle="collapse" data-bs-target="#history{{ approval.id }}">
                        View
                    </button>
                </td>
            </form>
        </tr>

        <!-- Collapsible History Row -->
        <tr class="collapse" id="history{{ approval.id }}">
            <td colspan="6">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Location</th>
                            <th>Remarks</th>
                            <th>Updated At</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for history in approval.history.all %}
                        <tr>
                            <td>{{ history.get_status_display }}</td>
                            <td>{{ history.get_location_display }}</td>
                            <td>{{ history.remarks|default:"--" }}</td>
                            <td>{{ history.updated_at }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center">No history available.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </td>
        </tr>
        {% endfor %}
    </tbody>
    </table>

</div>

{% endblock %}

