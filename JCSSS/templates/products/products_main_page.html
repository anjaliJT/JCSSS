
{% extends "base.html" %}

{% block title %}My Complaints - UAV Support Portal{% endblock %}

{% block content %}
       
        <!-- Main Content Area -->
        <div class="container-fluid">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col">
                    <h2 class="mb-0">Products Inventory</h2>
                    <p class="text-muted">Manage and track all UAV products in your inventory</p>
                </div>
                <div class="col-auto">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#importExportModal">
                        <i class="fas fa-file-csv me-2"></i>Import/Export
                    </button>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="get" id="filterForm" class="row g-3">

                        <!-- Product Model -->
                        <div class="col-12 col-md-4">
                            <label class="form-label">Product Model</label>
                            <select class="form-select" name="model" onchange="this.form.submit()">
                                <option value="">All Models</option>
                                {% for model in models %}
                                    <option value="{{ model.id }}" {% if selected_model == model.id|stringformat:"s" %}selected{% endif %}>
                                        {{ model.model_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Status -->
                        <div class="col-12 col-md-4">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="status" onchange="this.form.submit()">
                                <option value="">All Statuses</option>
                                <option value="available" {% if selected_status == "available" %}selected{% endif %}>Available</option>
                                <option value="sold" {% if selected_status == "sold" %}selected{% endif %}>Sold</option>
                            </select>
                        </div>

                        <!-- Warranty -->
                        <div class="col-12 col-md-4">
                            <label class="form-label">Warranty</label>
                            <select class="form-select" name="warranty" onchange="this.form.submit()">
                                <option value="">All</option>
                                <option value="active" {% if selected_warranty == "active" %}selected{% endif %}>Active</option>
                                <option value="expired" {% if selected_warranty == "expired" %}selected{% endif %}>Expired</option>
                            </select>
                        </div>

                    </form>
                </div>
            </div>


            <!-- Products Table View -->
            <div id="tableView">
                <div class="card">
                    <div class="card-body">

                        <!-- Column Toggle Controls -->
                        <div class="mb-3 d-flex justify-content-end">
    <!-- Filter Icon -->
    <button class="btn btn-outline-primary dropdown-toggle " type="button" id="columnFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-filter"></i>
    </button>

    <!-- Dropdown Menu with checkboxes -->
    <ul class="dropdown-menu p-3" aria-labelledby="columnFilterDropdown" style="min-width: 200px;">
        <li class="form-check">
            <input class="form-check-input column-toggle" type="checkbox" value="0" checked id="col0">
            <label class="form-check-label" for="col0">Product Code</label>
        </li>
        <li class="form-check">
            <input class="form-check-input column-toggle" type="checkbox" value="1" checked id="col1">
            <label class="form-check-label" for="col1">Model</label>
        </li>
        <li class="form-check">
            <input class="form-check-input column-toggle" type="checkbox" value="2" checked id="col2">
            <label class="form-check-label" for="col2">Order Name</label>
        </li>
        <li class="form-check">
            <input class="form-check-input column-toggle" type="checkbox" value="3" checked id="col3">
            <label class="form-check-label" for="col3">Manufacturing Date</label>
        </li>
        <li class="form-check">
            <input class="form-check-input column-toggle" type="checkbox" value="4" checked id="col4">
            <label class="form-check-label" for="col4">Status</label>
        </li>
        <li class="form-check">
            <input class="form-check-input column-toggle" type="checkbox" value="5" checked id="col5">
            <label class="form-check-label" for="col5">Warranty Status</label>
        </li>
        <li class="form-check">
            <input class="form-check-input column-toggle" type="checkbox" value="6" checked id="col6">
            <label class="form-check-label" for="col6">Warranty Expiry</label>
        </li>
        <li class="form-check">
            <input class="form-check-input column-toggle" type="checkbox" value="7" checked id="col7">
            <label class="form-check-label" for="col7">Actions</label>
        </li>
    </ul>
</div>


                        <!-- Table -->
                        {% comment %} <div class="table-responsive">
                            <table class="table table-hover" id="productTable">
                                <thead>
                                    <tr>
                                        <th>Product Code</th>
                                        <th>Model</th>
                                        <th>Order Name</th>
                                        <th>Manufacturing Date</th>
                                        <th>Status</th>
                                        <th>Warranty Status</th>
                                        <th>Warranty Expiry</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for product in products %}
                                    <tr>
                                        <td>{{ product.product_code }}</td>
                                        <td>{{ product.product_model }}</td>
                                        <td>{{ product.order_name }}</td>
                                        <td>{{ product.manufecturing_Date|date:"M d, Y" }}</td>
                                        <td>{{ product.is_sold|yesno:"Sold,Available" }}</td>
                                        <td>{{ product.warranty_status }}</td>
                                        <td>{{ product.warranty_expiry_date|date:"M d, Y" }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary">View</button>
                                            <button class="btn btn-sm btn-outline-secondary">Edit</button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div> {% endcomment %}

                        <div class="table-responsive">
    <table class="table table-hover" id="productTable">
        <thead>
            <tr>
                <th>Product Code</th>
                <th>Model</th>
                <th>Order Name</th>
                <th>Manufacturing Date</th>
                <th>Status</th>
                <th>Warranty Status</th>
                <th>Warranty Expiry</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
            <tr>
                <td>{{ product.product_code }}</td>
                <td>{{ product.product_model }}</td>
                <td>{{ product.order_name }}</td>
                <td>{{ product.manufecturing_Date|date:"Y-m-d" }}</td>
                <td>{{ product.is_sold|yesno:"Sold,Available" }}</td>
                <td>{{ product.warranty_status }}</td>
                <td>{{ product.warranty_expiry_date|date:"Y-m-d" }}</td>
                <td>
                <button class="edit-btn btn btn-sm btn-outline-primary"
        data-bs-toggle="modal" data-bs-target="#editProductModal"
        data-id="{{ product.id }}"
        {% if product.product_model %}
            data-model="{{ product.product_model.id }}"
        {% else %}
            data-model=""
        {% endif %}
        data-order="{{ product.order_name }}"
        data-manufacture="{{ product.manufecturing_Date|date:'Y-m-d' }}"
        data-warranty="{{ product.warranty_status }}"
        data-expiry="{{ product.warranty_expiry_date|date:'Y-m-d' }}">
    Edit
</button>


                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


<!-- âœ… Modal (only once, outside the loop) -->

<script>
document.addEventListener('DOMContentLoaded', function () {
    const editButtons = document.querySelectorAll('.edit-btn');
    const form = document.getElementById('editProductForm');

    editButtons.forEach(btn => {
        btn.addEventListener('click', function () {
            const id = this.dataset.id;
            form.action = `/product/products/${id}/edit/`;

            // Set input fields
            document.getElementById('orderName').value = this.dataset.order;
            document.getElementById('manufactureDate').value = this.dataset.manufacture;
            document.getElementById('warrantyExpiry').value = this.dataset.expiry;
            document.getElementById('warrantyStatus').value = this.dataset.warranty;

            // Set the select value for ForeignKey
            document.getElementById('productModel').value = this.dataset.model; // model ID
        });
    });
});

</script>



                        <!-- JS to toggle columns -->
                        <script>
                        document.querySelectorAll(".column-toggle").forEach(checkbox => {
                            checkbox.addEventListener("change", function() {
                                let colIndex = parseInt(this.value) + 1; // nth-child is 1-based
                                let display = this.checked ? "" : "none";
                                
                                document.querySelectorAll(`#productTable tr th:nth-child(${colIndex}), 
                                                        #productTable tr td:nth-child(${colIndex})`)
                                        .forEach(cell => cell.style.display = display);
                            });
                        });
                        </script>


                        <!-- Pagination -->
                        {% if products.has_other_pages %}
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span class="text-muted">
                                Page {{ products.number }} of {{ products.paginator.num_pages }}
                            </span>
                            <nav>
                                <ul class="pagination mb-0">
                                    {% if products.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ products.previous_page_number }}{% if request.GET.show_all %}&show_all=1{% endif %}">&laquo;</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                                    {% endif %}

                                    {% for num in products.paginator.page_range %}
                                        <li class="page-item {% if products.number == num %}active{% endif %}">
                                            <a class="page-link" href="?page={{ num }}{% if request.GET.show_all %}&show_all=1{% endif %}">{{ num }}</a>
                                        </li>
                                    {% endfor %}

                                    {% if products.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ products.next_page_number }}{% if request.GET.show_all %}&show_all=1{% endif %}">&raquo;</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Import/Export Modal -->
    <div class="modal fade" id="importExportModal" tabindex="-1" aria-labelledby="importExportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importExportModalLabel">Import/Export Products</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row align-items-stretch">
    <!-- Import Section -->
    <div class="col-md-6 d-flex">
        <div class="card flex-fill">
            <div class="card-body text-center">
                <i class="fas fa-file-import fa-3x mb-3"></i>
                <h4>Import Products</h4>
                <p>Upload a CSV file to import products into the system</p>

                <form method="post" action="{% url 'import_products' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="file" class="form-control mb-3" name="import_file" accept=".csv" required>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-upload me-2"></i>Import Products
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Export Section -->
    <div class="col-md-6 d-flex">
        <div class="card flex-fill">
            <div class="card-body text-center">
                <i class="fas fa-file-export fa-3x mb-3 text-primary"></i>
                <h4>Export Products</h4>
                <p>Export product data to CSV format for external use</p>

                <form method="get" action="{% url 'export_products' %}">
                    <div class="mt-1">
                        <label class="form-label">Date Range (From - To)</label>
                        <input type="date" class="form-control" id="fromDate" name="from_date" max="{{ today }}">
                    </div>
                    <div class="mt-1">
                        <input type="date" class="form-control" id="toDate" name="to_date" max="{{ today }}">
                    </div>

                    <button type="submit" class="btn btn-primary mt-4 w-100">
                        <i class="fas fa-download me-2"></i>Export to CSV
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

                    
                    <!-- CSV Format Guide -->
                    <div class="card mt-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">CSV Format Guide</h6>
                        </div>
                        <div class="card-body">
                            <p class="small">Your CSV file should include the following columns (in any order):</p>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="small">
                                        <li><code>product_code</code> (required, unique)</li>
                                        <li><code>product_model</code> (required)</li>
                                        <li><code>order_name</code> (required)</li>
                                        <li><code>manufecturing_Date</code> (YYYY-MM-DD)</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="small">
                                        <li><code>is_sold</code> (true/false)</li>
                                        <li><code>sold_date</code> (YYYY-MM-DD, optional)</li>
                                        <li><code>source_location</code></li>
                                        <li><code>warranty_period</code> (months)</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="mt-2">
                                <a href="/static/files/product.csv" download class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-download me-1"></i>Download Template
                                </a>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" id="editProductForm">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="editProductLabel">Edit Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
    <label class="form-label">Model</label>
    <select name="product_model" id="productModel" class="form-select">
        {% for model in models %}
                                    <option value="{{ model.id }}" {% if selected_model == model.id|stringformat:"s" %}selected{% endif %}>
                                        {{ model.model_name }}
                                    </option>
                                {% endfor %}
    </select>
</div>

                        <div class="col-md-6">
                            <label class="form-label">Order Name</label>
                            <input type="text" name="order_name" id="orderName" class="form-control">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Manufacturing Date</label>
                            <input type="date" name="manufecturing_Date" id="manufactureDate" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Warranty Expiry Date</label>
                            <input type="date" name="warranty_expiry_date" id="warrantyExpiry" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Warranty Status</label>
                        <select name="warranty_status" id="warrantyStatus" class="form-select" disabled>
                            <option value="Active">Active</option>
                            <option value="Expired">Expired</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {

            const csvFileInput = document.getElementById('csvFileInput');
            const fileInfo = document.getElementById('fileInfo');
            const importBtn = document.getElementById('importBtn');
            const selectAll = document.getElementById('selectAll');
            
            // Toggle sidebar with inner toggle button
            
            // View toggle functionality
            
            // CSV file input handling
            if (csvFileInput) {
                csvFileInput.addEventListener('change', function(e) {
                    if (this.files.length > 0) {
                        const file = this.files[0];
                        fileInfo.innerHTML = `
                            <div class="alert alert-info py-2">
                                <i class="fas fa-file-csv me-2"></i>
                                <strong>${file.name}</strong> (${formatFileSize(file.size)})
                            </div>
                        `;
                        importBtn.disabled = false;
                    } else {
                        fileInfo.innerHTML = '';
                        importBtn.disabled = true;
                    }
                });
            }
            
            // Select all functionality
            if (selectAll) {
                selectAll.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('#tableView .form-check-input');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = selectAll.checked;
                    });
                });
            }
            

            

            
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        });
    </script>
{% endblock %}