{% extends "uav-portal/base.html" %}
{% load static %}

{% block title %} UAV Event Reporting Form {% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
        border-left: 4px solid #0d6efd;
        border-right: 4px solid #0d6efd;
    }
    .form-section-title {
        color: #0d6efd;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    .help-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    .file-upload-preview {
        max-width: 100px;
        max-height: 100px;
        margin-right: 10px;
        margin-bottom: 10px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 4px;
    }
    .conditional-field {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">UAV Event Reporting Form</h2>
    
    <form method="post" action="{% url 'submit' %}" enctype="multipart/form-data" class=" bg-light">
        {% csrf_token %}
        
        <!-- Personal Information Section -->
        <div class="form-section">
            <h4 class="form-section-title">Personal Information</h4>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="pilotName" class="form-label required-field">Pilot Name</label>
                    <input type="text" class="form-control" id="pilotName" name="pilot_name" required>
                </div>
                <div class="col-md-6">
                    <label for="email" class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="email" name="email" placeholder="name@example.com">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="certificateNumber" class="form-label">Certificate Number</label>
                    <input type="text" class="form-control" id="certificateNumber" name="certificate_number" placeholder="Enter drone flying certificate number">
                </div>
                <div class="col-md-6">
                    <label for="designation" class="form-label">Designation</label>
                    <input type="text" class="form-control" id="designation" name="designation" placeholder="Enter your designation">
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-12">
                    <label for="organization" class="form-label required-field">Organization</label>
                    <input type="text" class="form-control" id="organization" name="organization" required>
                </div>
            </div>
        </div>

        <!-- Event Details Section -->
        <div class="form-section">
            <h4 class="form-section-title">Event Details</h4>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="modelNumber" class="form-label required-field">Model Number</label>
                    <input type="text" class="form-control" id="modelNumber" name="model_number" required>
                    <div class="help-text">Will be automatically converted to uppercase</div>
                </div>
                <div class="col-md-4">
                    <label for="dateOfOccurrence" class="form-label required-field">Date of Occurrence</label>
                    <input type="date" class="form-control" id="dateOfOccurrence" name="date_of_occurrence" required>
                </div>
                <div class="col-md-4">
                    <label for="timeOfOccurrence" class="form-label required-field">Time of Occurrence</label>
                    <input type="time" class="form-control" id="timeOfOccurrence" name="time_of_occurrence" required>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="fieldSite" class="form-label">Field/Site</label>
                    <input type="text" class="form-control" id="fieldSite" name="field_site" placeholder="Location where the event occurred">
                </div>
                <div class="col-md-6">
                    <label for="uavWeight" class="form-label required-field">UAV Weight (kg)</label>
                    <input type="number" step="0.01" class="form-control" id="uavWeight" name="uav_weight" required>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="eventType" class="form-label required-field">Event Type</label>
                    <select class="form-select" id="eventType" name="event_type" required>
                        <option value="" selected disabled>Select event type</option>
                        <option value="accident">Accident</option>
                        <option value="incident">Incident</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="damageLevel" class="form-label required-field">Damage Level</label>
                    <select class="form-select" id="damageLevel" name="damage_level" required>
                        <option value="" selected disabled>Select damage level</option>
                        <option value="none">None</option>
                        <option value="minor">Minor</option>
                        <option value="moderate">Moderate</option>
                        <option value="severe">Severe</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="flightMode" class="form-label required-field">Flight Mode</label>
                    <select class="form-select" id="flightMode" name="flight_mode" required>
                        <option value="" selected disabled>Select flight mode</option>
                        <option value="takeoff">Takeoff</option>
                        <option value="stabilize">Stabilize</option>
                        <option value="manual">Manual</option>
                        <option value="fbwa">FBWA</option>
                        <option value="rtl">RTL</option>
                        <option value="auto">Auto</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="eventPhase" class="form-label required-field">Event Phase</label>
                    <select class="form-select" id="eventPhase" name="event_phase" required>
                        <option value="" selected disabled>Select event phase</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="positioning">Positioning</option>
                        <option value="startup">Startup</option>
                        <option value="chuck_point">Chuck Point</option>
                        <option value="take_off">Take Off</option>
                        <option value="climb">Climb</option>
                        <option value="departure">Departure</option>
                        <option value="cruise">Cruise</option>
                        <option value="descent">Descent</option>
                        <option value="rejoin_approach">Rejoin/Approach</option>
                        <option value="final_phase">Final Phase</option>
                        <option value="landing_recovery">Landing/Recovery</option>
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="uavType" class="form-label required-field">UAV Type</label>
                    <select class="form-select" id="uavType" name="uav_type" required>
                        <option value="" selected disabled>Select UAV type</option>
                        <option value="fixed_wing">Fixed Wing</option>
                        <option value="multi_rotor">Multi Rotor</option>
                        <option value="hybrid">Hybrid VTOL</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="tailNumber" class="form-label">Tail Number</label>
                    <input type="text" class="form-control" id="tailNumber" name="tail_number" placeholder="Enter drone tail number">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="gcsType" class="form-label">GCS Type</label>
                    <input type="text" class="form-control" id="gcsType" name="gcs_type" placeholder="Enter GCS type">
                </div>
                <div class="col-md-6">
                    <label for="gcsNumber" class="form-label">GCS Number</label>
                    <input type="text" class="form-control" id="gcsNumber" name="gcs_number" placeholder="Enter GCS number">
                </div>
            </div>
        </div>

        <!-- Meteorology Section -->
        <div class="form-section">
            <h4 class="form-section-title">Meteorological Conditions</h4>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="wind" class="form-label">Wind</label>
                    <input type="text" class="form-control" id="wind" name="wind" placeholder="Enter wind speed ">
                </div>
                <div class="col-md-4">
                    <label for="temperature" class="form-label">Temperature (Â°C)</label>
                    <input type="number" class="form-control" id="temperature" name="temperature" placeholder="Enter temperature">
                </div>
                <div class="col-md-4">
                    <label for="pressureQnh" class="form-label">Pressure QNH (hPa)</label>
                    <input type="text" class="form-control" id="pressureQnh" name="pressure_qnh" placeholder="Enter QNH Pressure">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="visibility" class="form-label">Visibility</label>
                    <input type="text" class="form-control" id="visibility" name="visibility" placeholder="Enter Visivility">
                </div>
                <div class="col-md-4">
                    <label for="clouds" class="form-label">Clouds</label>
                    <input type="number" class="form-control" id="clouds" name="clouds" placeholder="Enter Cloud condition">
                </div>
                <div class="col-md-4">
                    <label for="humidity" class="form-label">Humidity</label>
                    <input type="text" class="form-control" id="humidity" name="humidity" placeholder="Enter QNH Pressure">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="form-label">Weather Conditions</label>
                    <div class="d-flex flex-wrap gap-4">
                        <div class="form-check">
                            <input class="form-check-input" name="turbulence" type="checkbox" id="turbulence">
                            <label class="form-check-label" for="turbulence">Turbulence</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" name="windshear" type="checkbox" id="windshear">
                            <label class="form-check-label" for="windshear">Wind Shear</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" name="rain" type="checkbox" id="rain">
                            <label class="form-check-label" for="rain">Rain</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" name="icing" type="checkbox" id="icing">
                            <label class="form-check-label" for="icing">Icing</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" name="snow" type="checkbox" id="snow">
                            <label class="form-check-label" for="snow">Snow</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Event Description Section -->
        <div class="form-section">
            <h4 class="form-section-title">Event Description</h4>
            
            <div class="mb-3">
                <label for="eventDescription" class="form-label required-field">Event Description</label>
                <textarea class="form-control" id="eventDescription" name="event_description" rows="4" required></textarea>
            </div>

            <div class="mb-3">
                <label for="initialActionsTaken" class="form-label">Initial Actions Taken</label>
                <textarea class="form-control" id="initialActionsTaken" name="initial_actions_taken" rows="3"></textarea>
            </div>

            <div class="mb-3">
                <label for="remarks" class="form-label">Remarks (Optional)</label>
                <textarea class="form-control" id="remarks" name="remarks" rows="2"></textarea>
            </div>
        </div>

        <!-- Attachments Section -->
        <div class="form-section">
            <h4 class="form-section-title">Attachments</h4>
            
            <div class="mb-3">
                <label for="videoFile" class="form-label">Upload Video (Optional)</label>
                <input type="file" class="form-control" id="videoFile" name="file_video" accept=".mp4,.avi,.mov,.mkv">
                <div class="help-text">Accepted formats: MP4, AVI, MOV, MKV</div>
            </div>

            <div class="mb-3">
                <label class="form-label">Upload Photos (Optional, Max 3)</label>
                <input type="file" class="form-control mb-2" name="file_image1" accept=".jpg,.jpeg,.png,.gif">
                <input type="file" class="form-control mb-2" name="file_image2" accept=".jpg,.jpeg,.png,.gif">
                <input type="file" class="form-control" name="file_image3" accept=".jpg,.jpeg,.png,.gif">
                <div class="help-text">Accepted formats: JPG, JPEG, PNG, GIF</div>
            </div>

            <div class="mb-3">
                <label for="logFile" class="form-label required-field">Upload Log File</label>
                <input type="file" class="form-control" id="logFile" name="file_log" accept=".txt,.log,.csv" required>
                <div class="help-text">Accepted formats: TXT, LOG, CSV</div>
            </div>
        </div>

        <!-- Form Submission -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <button type="reset" class="btn btn-secondary me-md-2">Reset Form</button>
            <button type="submit" class="btn btn-primary">Submit Report</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Form validation
        const form = document.querySelector('form');
        form.addEventListener('submit', function(event) {
            let isValid = true;
            
            // Check required fields
            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('is-invalid');
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                event.preventDefault();
                alert('Please fill in all required fields.');
            }
        });
        
        // File input preview (for images)
        const fileInputs = document.querySelectorAll('input[type="file"]');
        fileInputs.forEach(input => {
            input.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    
                    // Check file size (max 10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        alert('File size exceeds 10MB. Please choose a smaller file.');
                        this.value = '';
                        return;
                    }
                    
                    // Preview images
                    if (file.type.match('image.*')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            // Create preview if it doesn't exist
                            let preview = input.nextElementSibling;
                            if (!preview || !preview.classList.contains('file-upload-preview')) {
                                preview = document.createElement('img');
                                preview.classList.add('file-upload-preview', 'mt-2');
                                input.parentNode.appendChild(preview);
                            }
                            preview.src = e.target.result;
                        }
                        reader.readAsDataURL(file);
                    }
                }
            });
        });
        
        // Show/hide fields based on selections
        const eventTypeSelect = document.getElementById('eventType');
        if (eventTypeSelect) {
            eventTypeSelect.addEventListener('change', function() {
                // You can add conditional logic here based on event type
            });
        }
    });
</script>
{% endblock %}