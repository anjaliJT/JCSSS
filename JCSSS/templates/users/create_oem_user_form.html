

<style>
    .form-label.required::after {
        content: " *";
        color: #dc3545;
    }
</style>

<!-- User Form Modal -->
<div class="modal fade" id="userFormModal" tabindex="-1" aria-labelledby="userFormLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-white">
                <h5 class="modal-title" id="userFormLabel">
                    <i class="fas fa-user-plus me-2"></i><span id="formTitle">Create New User</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" id="userForm" novalidate action="{% url 'create_oem_user' %}">
                {% csrf_token %}
                
                <div class="modal-body">
                    <!-- Identity Information Section -->
                    <h6 class="card-title mb-3 ">
                        <i class="fas fa-id-card me-2"></i>Identity Information
                    </h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">First Name</label>
                            <input type="text" name="first_name" id="firstName" class="form-control" placeholder="e.g., Sneha" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Last Name</label>
                            <input type="text" name="last_name" id="lastName" class="form-control" placeholder="e.g., Sharma" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Official Email</label>
                            <input type="email" name="email" id="email" class="form-control" placeholder="name@command.in" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required">Phone Number</label>
                            <input type="text" name="phone_number" id="phoneNumber" class="form-control" placeholder="10-digit number" 
                                   maxlength="10" pattern="^[0-9]{10}$" required>
                            <small class="form-text text-muted">Must be exactly 10 digits</small>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Certificate Number</label>
                            <input type="text" name="certificate_number" id="certificateNumber" class="form-control" placeholder="Enter certificate ID">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Designation</label>
                            <input type="text" name="designation" id="designation" class="form-control" placeholder="e.g., Flight Commander">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Command / Unit</label>
                            <input type="text" name="command_name" id="commandName" class="form-control" placeholder="e.g., Western Air Command">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Account Status</label>
                            <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" name="is_active" id="isActiveSwitch" checked>
                                <label class="form-check-label" for="isActiveSwitch">Active</label>
                            </div>
                        </div>
                    </div>

                    <!-- Role & Access Section -->
                    <h6 class="mb-3 card-title">
                        <i class="fas fa-user-shield me-2"></i>Role & Access
                    </h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label required">Role</label>
                            <select class="form-select" name="role" id="role" required>
                                <option value="">Select role...</option>
                                {% for value, label in role_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Security & Password Section -->
                    <h6 class="mb-3 card-title">
                        <i class="fas fa-lock me-2"></i>Security & Password
                    </h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Initial Password</label>
                            <input type="password" name="password1" id="password1" class="form-control" placeholder="Leave blank to auto-generate">
                            <small class="form-text text-muted">Auto-generated if left blank</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" name="password2" id="password2" class="form-control" placeholder="Confirm password">
                        </div>
                    </div>
                    <div class="row mb-3" id="sendInviteSection">
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="send_invite" id="sendInviteSwitch" checked>
                                <label class="form-check-label" for="sendInviteSwitch">
                                    <i class="fas fa-paper-plane me-1"></i>Send invitation email with password setup link
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3" id="passwordInfo" style="display: none;">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>Leave password fields blank to keep the current password unchanged.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">Create User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const userForm = document.getElementById('userForm');
    const formTitle = document.getElementById('formTitle');
    const submitBtn = document.getElementById('submitBtn');
    
    const createBtn = document.getElementById('createUserBtn');
    if (createBtn) {
        createBtn.addEventListener('click', function () {
            resetForm();
            formTitle.textContent = 'Create New User';
            submitBtn.innerHTML = 'Create User';
            userForm.action = "{% url 'create_oem_user' %}";
        });
    }
    
    const editButtons = document.querySelectorAll('.edit-user-btn');
    editButtons.forEach(btn => {
        btn.addEventListener('click', function () {
            const id = this.dataset.id;
            formTitle.textContent = 'Edit User';
            submitBtn.innerHTML = 'Update User';
            userForm.action = `/users/${id}/edit/`;

            // Populate form fields with user data
            document.getElementById('firstName').value = this.dataset.firstName || '';
            document.getElementById('lastName').value = this.dataset.lastName || '';
            document.getElementById('email').value = this.dataset.email || '';
            document.getElementById('phoneNumber').value = this.dataset.phone || '';
            document.getElementById('certificateNumber').value = this.dataset.certificate || '';
            document.getElementById('designation').value = this.dataset.designation || '';
            document.getElementById('commandName').value = this.dataset.command || '';
            document.getElementById('role').value = this.dataset.role || '';
            
            const isActiveSwitch = document.getElementById('isActiveSwitch');
            if (isActiveSwitch) {
                isActiveSwitch.checked = this.dataset.isActive === 'true';
            }
            
            // Show/hide sections for edit mode
            document.getElementById('sendInviteSection').style.display = 'none';
            document.getElementById('passwordInfo').style.display = 'block';
        });
    });
    
    function resetForm() {
        userForm.reset();
        document.querySelectorAll('.form-control, .form-select').forEach(field => {
            field.classList.remove('is-invalid', 'is-valid');
        });
        
        // Reset switches
        const sendInviteSwitch = document.getElementById('sendInviteSwitch');
        if (sendInviteSwitch) {
            sendInviteSwitch.checked = true;
        }
        
        const isActiveSwitch = document.getElementById('isActiveSwitch');
        if (isActiveSwitch) {
            isActiveSwitch.checked = true;
        }
        
        // Show/hide sections for create mode
        document.getElementById('sendInviteSection').style.display = 'block';
        document.getElementById('passwordInfo').style.display = 'none';
    }

    userForm.addEventListener('submit', function (e) {
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phoneNumber').value;
        const role = document.getElementById('role').value;
        const password1 = document.getElementById('password1').value;
        const password2 = document.getElementById('password2').value;
        
        // Validate required fields
        if (!email || !phone || !role) {
            e.preventDefault();
            alert('Please fill in all required fields (marked with *)');
            return false;
        }
        
        // Phone validation
        if (!/^\d{10}$/.test(phone)) {
            e.preventDefault();
            alert('Phone number must be exactly 10 digits');
            return false;
        }
        
        // Password validation if provided
        if (password1 || password2) {
            if (password1 !== password2) {
                e.preventDefault();
                alert('Passwords do not match');
                return false;
            }
            if (password1.length < 8) {
                e.preventDefault();
                alert('Password must be at least 8 characters long');
                return false;
            }
        }
        
        if (!userForm.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        userForm.classList.add('was-validated');
    });
});
</script>